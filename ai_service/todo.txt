# AI Service Refactoring Tasks

## Code Review Results
- Files Reviewed: 15+
- Critical Issues: 5
- Warnings: 6
- Suggestions: 4

---

## Phase 1: Fix Critical Bugs (PRIORITY: CRITICAL)

### Task 1.1: Fix LLMService Indentation Bug ✅ COMPLETED
- [x] Move `run_security_analysis` method out of `__init__`
- [x] Move `_build_rag_security_prompt` method out of `__init__`
- [x] Verify LLMService still works after fix
- [x] Made `run_security_analysis` async and use httpx client
- [x] Added proper error handling and type hints
- File: `app/services/llm_service.py` (lines 63-106)

### Task 1.2: Remove Duplicate Endpoints from endpoints.py ✅ COMPLETED
- [x] Remove `/ai/health` - exists in `routers/health.py`
- [x] Remove `/ai/agents/status` - exists in `routers/health.py`
- [x] Remove duplicate security endpoints - exist in `routers/security_analysis.py`
- [x] Remove duplicate test generation endpoints - exist in `routers/test_generation.py`
- [x] Remove duplicate mock server endpoints - exist in `routers/mock_server.py`
- [x] Remove duplicate cache endpoints - exist in `routers/cache_management.py`
- [x] Remove duplicate patch endpoints - exist in `routers/patch_operations.py`
- [x] Remove attack path simulation endpoints - exist in `routers/security_analysis.py`
- [x] Kept `sanitize_openapi_spec` helper function (imported by test_generation.py)
- [x] Verified Python syntax is valid
- File initially reduced from 3805 lines to 1615 lines (58% reduction)
- Further reduced to 193 lines in Task 6.3 (95% total reduction)

---

## Phase 2: Create New Domain Routers (PRIORITY: HIGH) ✅ COMPLETED

### Task 2.1: Create AI Processing Router ✅ COMPLETED
- [x] Create `app/api/v1/routers/ai_processing.py`
- [x] Move `/ai/process` endpoint
- [x] Move `/ai/generate` endpoint
- [x] Use `Depends()` for service injection
- [x] Add proper type hints and Pydantic models

### Task 2.2: Create Workflow Router ✅ COMPLETED
- [x] Create `app/api/v1/routers/workflow.py`
- [x] Move `/ai/workflow/{workflow_name}` endpoint
- [x] Move `/ai/workflow/custom` endpoint
- [x] Move `/ai/workflows` endpoint
- [x] Use `Depends()` for service injection

### Task 2.3: Create Context Management Router ✅ COMPLETED
- [x] Create `app/api/v1/routers/context.py`
- [x] Move `/ai/context/session` POST endpoint
- [x] Move `/ai/context/session/{session_id}` GET endpoint
- [x] Move `/ai/context/statistics` endpoint
- [x] Use `Depends()` for service injection

### Task 2.4: Create Prompt Engine Router ✅ COMPLETED
- [x] Create `app/api/v1/routers/prompt.py`
- [x] Move `/ai/prompt/generate` endpoint
- [x] Move `/ai/prompt/statistics` endpoint
- [x] Use `Depends()` for service injection

### Task 2.5: Create Explanation Router ✅ COMPLETED
- [x] Create `app/api/v1/routers/explanation.py`
- [x] Move `/ai/explain` endpoint
- [x] Move `/ai/rag/status` endpoint
- [x] Note: `EXPLANATION_CACHE` migration to `ICacheRepository` deferred to Phase 4
- [x] Use `Depends()` for service injection

### Task 2.6: Create Meta Analysis Router ✅ COMPLETED
- [x] Create `app/api/v1/routers/meta_analysis.py`
- [x] Move `/ai/meta-analysis` endpoint
- [x] Move `/ai/analyze-descriptions` endpoint
- [x] Use `Depends()` for service injection

### Task 2.7: Update Router Aggregation ✅ COMPLETED
- [x] Add new routers to `app/api/v1/api.py`
- [x] Verified Python syntax of all new files

---

## Phase 3: Migrate to Dependency Injection (PRIORITY: HIGH) ✅ COMPLETED

### Task 3.1: Update AI Processing Router ✅ COMPLETED
- [x] Replace global `llm_service` with `Depends(get_llm_service)` (already done)
- [x] Replace global `agent_manager` with `Depends(get_agent_manager)` (already done)
- [x] Replace global `context_manager` with proper DI
- [x] Added `get_context_manager()` to `app/api/deps.py` (singleton via @lru_cache)
- [x] Updated `ai_processing.py` to import from `deps.py`

### Task 3.2: Update All New Routers ✅ COMPLETED
- [x] Ensure all routers use `Depends()` pattern
- [x] Remove module-level service instantiations
- [x] Verify services are properly injected
- [x] Added `get_prompt_engine()` to `app/api/deps.py` (singleton via @lru_cache)
- [x] Updated `context.py` to import `get_context_manager` from `deps.py`
- [x] Updated `prompt.py` to import `get_prompt_engine` from `deps.py`
- [x] All routers now use centralized dependency injection
- [x] All Python syntax verified valid

---

## Phase 4: Replace Global Caches (PRIORITY: MEDIUM) ✅ COMPLETED

### Task 4.1: Migrate SECURITY_ANALYSIS_CACHE ✅ COMPLETED
- [x] Migrated `security_analysis.py` to use `ICacheRepository` via `Depends(get_cache_repository)`
- [x] Updated helper functions `_get_cached_security_report` and `_cache_security_report` to be async
- [x] Added cache key prefixes: `security:` and `attack_path:`
- [x] Legacy cache in `endpoints.py` marked as DEPRECATED (kept for backward compatibility)

### Task 4.2: Migrate EXPLANATION_CACHE ✅ COMPLETED
- [x] Migrated `explanation.py` to use `ICacheRepository` via `Depends(get_cache_repository)`
- [x] Migrated `rag_knowledge.py` to use `ICacheRepository` via `Depends(get_cache_repository)`
- [x] Updated helper functions to be async with cache key prefix `explanation:`
- [x] Legacy cache in `endpoints.py` marked as DEPRECATED (kept for backward compatibility)

### Task 4.3: Migrate MOCKED_APIS ✅ COMPLETED
- [x] Migrated `mock_server.py` to use existing `AsyncMockStorage` class consistently
- [x] Updated `get_mock_server_info`, `delete_mock_server`, `handle_mock_request` to use `mock_storage`
- [x] Removed `MOCKED_APIS` global from `endpoints.py`
- [x] `AsyncMockStorage` provides thread-safe operations with asyncio locks
- Note: For horizontal scaling, consider Redis-backed ICacheRepository in future

### Task 4.4: Update cache_management.py ✅ COMPLETED
- [x] Updated `/ai/cache/stats` to use `ICacheRepository`
- [x] Updated `/ai/cache/clear` to use pattern-based clearing
- [x] Updated `/ai/security/cache/stats` to use `ICacheRepository`
- [x] Updated `/ai/security/cache/clear` to clear both `security:*` and `attack_path:*` patterns

---

## Phase 5: Update Router Aggregation (PRIORITY: MEDIUM) ✅ COMPLETED

### Task 5.1: Update api.py ✅ COMPLETED
- [x] All new routers already added to `api.py`
- [x] Legacy `endpoints.py` router kept for backward compatibility (marked DEPRECATED)
- [x] Updated router metadata documentation with comprehensive endpoint listing
- [x] Updated module docstring with migration status and architecture overview

---

## Phase 6: Final Cleanup (PRIORITY: LOW) ✅ COMPLETED

### Task 6.1: Code Quality ✅ COMPLETED
- [x] `endpoints.py` kept for backward compatibility (legacy endpoints marked DEPRECATED)
- [x] All Python files verified with valid syntax
- [x] No linter available but syntax validation passed for all 18 files

### Task 6.2: Documentation ✅ COMPLETED
- [x] Updated `api.py` docstring with complete architecture overview
- [x] Updated `ROUTER_METADATA` with all new routers and deprecation notices
- [x] Inline deprecation comments added to legacy code in `endpoints.py`

### Task 6.3: Remove Duplicate Code from endpoints.py ✅ COMPLETED
- [x] Removed all duplicate endpoints that exist in new domain routers
- [x] Kept only legacy `/process` and `/specifications/generate` endpoints for backward compatibility
- [x] Kept `sanitize_openapi_spec` helper function (imported by test_generation.py)
- [x] Updated legacy endpoints to use proper dependency injection
- [x] Added `deprecated=True` flag to legacy endpoints
- [x] Reduced `endpoints.py` from 1626 lines to 193 lines (88% reduction)
- [x] All 20 Python files verified with valid syntax

### Task 6.4: Remaining Items (Future Work)
- [ ] Remove `endpoints.py` entirely once clients migrate to new endpoints
- [x] Migrate `MOCKED_APIS` - completed using `AsyncMockStorage` (thread-safe)
- [ ] Add comprehensive integration tests for new routers
- [ ] Consider migrating `AsyncMockStorage` to Redis-backed ICacheRepository for horizontal scaling

---

## Verification Checklist

- [ ] All tests pass: `pytest ai_service/`
- [ ] Service starts: `uvicorn app.main:app --reload`
- [ ] No duplicate endpoint warnings in logs
- [ ] Health check works: `GET /health`
- [ ] AI processing works: `POST /ai/process`
- [ ] Security analysis works: `POST /ai/security/analyze`
- [ ] No race conditions under load (test with `wrk` or `ab`)
- [x] All Python files have valid syntax (verified - 20 files)

---

## Reference: Endpoints Migration Status (Updated)

| Endpoint | Target Router | Status |
|----------|---------------|--------|
| POST /ai/process | ai_processing.py | ✅ New router created |
| POST /ai/generate | ai_processing.py | ✅ New router created |
| POST /ai/workflow/{name} | workflow.py | ✅ New router created |
| POST /ai/workflow/custom | workflow.py | ✅ New router created |
| GET /ai/workflows | workflow.py | ✅ New router created |
| POST /ai/context/session | context.py | ✅ New router created |
| GET /ai/context/session/{id} | context.py | ✅ New router created |
| GET /ai/context/statistics | context.py | ✅ New router created |
| POST /ai/prompt/generate | prompt.py | ✅ New router created |
| GET /ai/prompt/statistics | prompt.py | ✅ New router created |
| POST /process | endpoints.py (legacy) | Kept for backward compat |
| POST /specifications/generate | endpoints.py (legacy) | Kept for backward compat |
| POST /ai/meta-analysis | meta_analysis.py | ✅ New router created |
| POST /ai/analyze-descriptions | meta_analysis.py | ✅ New router created |
| POST /ai/explain | explanation.py | ✅ New router created |
| GET /ai/rag/status | explanation.py | ✅ New router created |

### New Routers Created:
- `app/api/v1/routers/ai_processing.py` - Core AI processing endpoints
- `app/api/v1/routers/workflow.py` - Workflow management endpoints
- `app/api/v1/routers/context.py` - Context/session management endpoints
- `app/api/v1/routers/prompt.py` - Prompt engine endpoints
- `app/api/v1/routers/explanation.py` - AI explanations and RAG endpoints
- `app/api/v1/routers/meta_analysis.py` - Meta analysis endpoints

---

## Notes

- All new routers should follow the pattern in `routers/health.py`
- Use type hints for ALL function parameters and return types
- Use Pydantic models instead of `Dict[str, Any]` where possible
- Add docstrings following NumPy style
- Use `logger.exception()` instead of `logger.error(str(e))`
